# ShopTools v1.2.5 新功能详解

## 🎯 版本概述

ShopTools v1.2.5 是一个重要的功能更新版本，主要新增了强大的商店删除功能和调试模式控制，同时修复了多个技术问题，提升了插件的稳定性和用户体验。

## 🚀 核心新功能

### 1. 商店删除功能 (`/shoptools ban`)

#### 功能描述
- **命令格式**：`/shoptools ban <玩家名>` 或 `/st ban <玩家名>`
- **功能**：批量删除指定玩家的所有商店
- **权限要求**：`shoptools.admin` + QuickShop的removeall权限
- **执行限制**：只能由玩家执行，不支持控制台

#### 技术实现
- **官方API**：使用QuickShop官方的 `/qs removeall` 命令
- **持久化删除**：确保删除后重启服务器商店不会恢复
- **自动备份**：删除前自动备份所有商店数据
- **数据同步**：删除后自动从QuickShop重新读取商店数据

#### 执行流程
1. **权限验证**：检查执行者权限和玩家身份
2. **商店查询**：获取目标玩家的所有商店信息
3. **数据备份**：自动备份到 `shop_backups` 文件夹
4. **执行删除**：调用QuickShop的removeall命令
5. **数据同步**：重新从QuickShop读取最新数据
6. **结果反馈**：显示操作结果和建议

### 2. 调试模式控制 (`admin.ban-debug`)

#### 配置说明
```yaml
admin:
  # ban命令调试模式
  # 启用时显示详细的删除和同步信息
  # 禁用时只显示简洁的成功信息
  ban-debug: false
```

#### 输出对比

**简洁模式 (ban-debug: false)**
```
成功删除玩家 XRZQQ_QWQ 的商店！
商店数据同步完成！
```

**详细模式 (ban-debug: true)**
```
开始使用QuickShop官方removeall命令删除玩家 XRZQQ_QWQ 的 48 个商店...

成功删除玩家 XRZQQ_QWQ 的商店！
使用QuickShop官方removeall命令
预计删除: 48 个商店
备份文件已保存到 shop_backups 文件夹
正在同步商店数据...
商店数据同步完成！
已从QuickShop重新读取 1234 个商店数据
建议重启服务器以确保删除效果完全生效！
```

## 🔧 技术改进

### 1. 线程安全优化

#### 问题修复
- **问题**：QuickShop API在异步线程中调用导致错误
- **错误信息**：`#[Illegal Access] This method require runs on server main thread.`
- **解决方案**：在主线程中调用QuickShop API，然后异步处理数据

#### 实现方式
```java
// 主线程：调用QuickShop API
Bukkit.getScheduler().runTaskLater(plugin, () -> {
    List<ShopData> latestShopData = plugin.getQuickShopIntegration().getAllShops();
    
    // 异步线程：更新缓存
    Bukkit.getScheduler().runTaskAsynchronously(plugin, () -> {
        plugin.getDataManager().updateShopData(latestShopData);
    });
}, 60L);
```

### 2. 数据同步机制

#### 同步流程
1. **重新初始化**：重新建立QuickShop连接
2. **延迟执行**：等待3秒让QuickShop处理删除操作
3. **数据获取**：在主线程中获取最新商店数据
4. **缓存更新**：在异步线程中更新ShopTools缓存
5. **结果反馈**：在主线程中发送完成消息

#### 性能优化
- **异步处理**：避免主线程阻塞
- **延迟执行**：确保数据一致性
- **批量更新**：一次性更新所有缓存数据

### 3. 错误处理增强

#### 完善的异常处理
- **权限检查**：详细的权限验证和错误提示
- **执行失败**：清晰的失败原因分析
- **数据同步**：同步失败时的回退方案
- **日志记录**：完整的操作日志记录

## 📊 配置更新

### 新增配置项

#### admin.ban-debug
- **类型**：boolean
- **默认值**：false
- **作用**：控制ban命令输出信息的详细程度
- **建议**：生产环境建议设为false，调试时设为true

### 版本兼容性
- **向后兼容**：现有配置文件无需修改
- **自动补全**：缺失的配置项会使用默认值
- **配置验证**：启动时验证配置文件完整性

## 🎮 用户体验提升

### 1. 简洁的输出模式
- **减少信息干扰**：关闭调试模式时只显示关键信息
- **保持控制台日志**：详细信息仍记录在控制台
- **灵活控制**：管理员可根据需要切换模式

### 2. 实时状态反馈
- **进度提示**：显示操作进行状态
- **结果确认**：明确的成功/失败反馈
- **建议提供**：操作后的建议和注意事项

### 3. 权限友好设计
- **清晰提示**：权限不足时的明确说明
- **执行限制**：合理的执行者限制说明
- **安全保护**：防止误操作的多重验证

## ⚠️ 使用注意事项

### 权限要求
1. **ShopTools权限**：`shoptools.admin`
2. **QuickShop权限**：`quickshop.removeall`
3. **执行者限制**：只能由玩家执行

### 安全建议
1. **谨慎使用**：删除操作不可逆，请谨慎执行
2. **备份验证**：确认备份文件正常生成
3. **权限控制**：严格控制ban命令的使用权限
4. **服务器重启**：删除大量商店后建议重启服务器

### 故障排除
1. **权限问题**：确认执行者有相应权限
2. **线程错误**：已在v1.2.5中修复
3. **数据不同步**：自动同步机制已优化
4. **控制台执行**：改为玩家执行即可

## 🚀 升级建议

### 从旧版本升级
1. **备份数据**：升级前备份现有数据
2. **停止服务器**：安全升级流程
3. **替换插件**：使用新版本JAR文件
4. **启动验证**：确认插件正常加载
5. **配置检查**：验证新配置项是否生效

### 配置迁移
- **自动兼容**：现有配置自动兼容
- **新增项目**：ban-debug默认为false
- **无需手动修改**：插件自动处理配置更新

## 📈 性能影响

### 资源使用
- **内存占用**：轻微增加（新增配置和功能）
- **CPU使用**：优化的异步处理，影响极小
- **磁盘IO**：备份功能会产生少量磁盘写入

### 网络影响
- **QuickShop通信**：使用官方API，影响最小
- **数据同步**：一次性批量操作，效率高
- **玩家体验**：异步处理，无感知延迟

## 🎯 未来规划

### 计划功能
- **批量操作**：支持批量删除多个玩家的商店
- **定时清理**：自动清理长期不活跃玩家的商店
- **恢复功能**：从备份文件恢复已删除的商店
- **统计报告**：详细的删除操作统计和报告

### 技术优化
- **性能提升**：进一步优化大量商店的处理速度
- **兼容性**：支持更多QuickShop版本和分支
- **API扩展**：提供更多的开发者API接口

## 总结

ShopTools v1.2.5 是一个重要的里程碑版本，成功实现了：

- ✅ **强大的商店删除功能**：安全、可靠、持久化
- ✅ **灵活的调试模式**：适应不同使用场景
- ✅ **完善的技术架构**：线程安全、异步优化
- ✅ **优秀的用户体验**：简洁输出、实时反馈

这个版本为服务器管理员提供了强大而安全的商店管理工具，同时保持了插件的稳定性和易用性。立即升级体验全新功能！🚀
